<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-02-25">

<title>Classification and Regression Trees</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="CART_files/libs/clipboard/clipboard.min.js"></script>
<script src="CART_files/libs/quarto-html/quarto.js"></script>
<script src="CART_files/libs/quarto-html/popper.min.js"></script>
<script src="CART_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="CART_files/libs/quarto-html/anchor.min.js"></script>
<link href="CART_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="CART_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="CART_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="CART_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="CART_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Classification and Regression Trees</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 25, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="instructions" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Instructions</h1>
<p>Participate in Kaggle’s <a href="https://www.kaggle.com/c/house-prices-advanced-regression-techniques/">House Prices: Advanced Regression Techniques</a> competition, where among other things you will:</p>
<ol type="1">
<li>Fit CART models, specifically regression models to a continuous outcome variable y</li>
<li>Compare different <em>estimates</em> of the RMSLE score on the test data returned by Kaggle</li>
<li>Study how the complexity parameter cp affects the various RMSLE scores we can compute. This is the <span class="math inline">\(\alpha\)</span> parameter from the equation that CART tries to minimize for numerical y <span class="math inline">\(RSS + \alpha |T|\)</span>. Note such parameters that control the degree of learning are also called “hyperparameters”</li>
<li>Identify an <strong>optimal</strong> cp to make a Kaggle submission to.</li>
</ol>
<section id="suggested-workflow" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="suggested-workflow"><span class="header-section-number">1.1</span> Suggested workflow</h2>
<ol type="1">
<li>Knit this file and read all instructions</li>
<li>This problem set is <strong>a step up in complexity</strong>. Follow the Minimally Viable Product approach</li>
<li>On Moodle, submit a <code>.zip</code> compressed/archived file of this <strong>entire</strong> RStudio project folder. We are doing this to ensure the graders can reproduce your Quarto file.</li>
</ol>
<center>
<img src="images/MVP2.png" width="60%">
</center>
</section>
<section id="evaluation-criteria" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="evaluation-criteria"><span class="header-section-number">1.2</span> Evaluation criteria</h2>
<p>Grading will be done on a progressive scale:</p>
<ol type="1">
<li>Minimum Viable Product Phase 1 (6/10)
<ol type="1">
<li>Did you complete honor code section?</li>
<li>Does your Quarto file knit? Submissions that don’t knit will be penalized harshly. So render early, render often.</li>
<li>All questions in this phase</li>
</ol></li>
<li>Due Diligence Phase 2 (7/10)
<ol type="1">
<li>Successful completion of all previous phases</li>
<li>All questions in this phase</li>
</ol></li>
<li>Phase 3 (8/10)
<ol type="1">
<li>Successful completion of all previous phases</li>
<li>All questions in this phase</li>
</ol></li>
<li>Phase 4 (9/10)
<ol type="1">
<li>Successful completion of all previous phases</li>
<li>All questions in this phase</li>
</ol></li>
<li>Phase 5 (9.5/10)
<ol type="1">
<li>Successful completion of all previous phases</li>
<li>All questions in this phase</li>
</ol></li>
<li>Point of Diminished Returns Phase 6 (10/10)
<ol type="1">
<li>Successful completion of all previous phases</li>
<li>All questions in this phase</li>
</ol></li>
</ol>
</section>
</section>
<section id="honor-code" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Honor Code</h1>
<ul>
<li>Indicate anybody you collaborated with:</li>
<li>Indicate that you did not directly copy anybody else’s code: I did not directly copy anybody else’s code.</li>
<li>Indicate that you did not use ChatGPT for this problem set: I did not use ChatGPT for this problem set.</li>
</ul>
</section>
<section id="model-using-previously-seen-variables" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Model using previously seen variables</h1>
<p>Here are the variables we’ll use in our CART model:</p>
<ol type="1">
<li>Outcome variable <code>SalePrice</code> directly i.e.&nbsp;don’t log-transform it</li>
<li>The 6 predictor variables from the PS1 solutions</li>
<li>The HalfBath variable from the lecture on overfitting</li>
<li>LotArea</li>
</ol>
<p>Below is the data pre-processing necessary to</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace missing value in KitchenQual variable in test set</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span> </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">KitchenQual =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(KitchenQual), KitchenQual, <span class="st">"TA"</span>))</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Deal with categorical predictor MSSubClass that had a level in test</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># data that didn't exist in training data. Do this by lumping all but</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># top two levels in new level "other". Remember to do this to both </span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># training and test</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>training <span class="ot">&lt;-</span> training <span class="sc">%&gt;%</span> </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">MSSubClassClean =</span> <span class="fu">ifelse</span>(MSSubClass <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"20"</span>, <span class="st">"60"</span>), MSSubClass, <span class="st">"other"</span>))</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span> </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">MSSubClassClean =</span> <span class="fu">ifelse</span>(MSSubClass <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"20"</span>, <span class="st">"60"</span>), MSSubClass, <span class="st">"other"</span>)) </span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Restrict to just the variables we'll use</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>training <span class="ot">&lt;-</span> training <span class="sc">%&gt;%</span> </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Id, GrLivArea, YearBuilt, BedroomAbvGr, SaleCondition, KitchenQual, </span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>         MSSubClassClean, HalfBath, LotArea, SalePrice)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span> </span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Id, GrLivArea, YearBuilt, BedroomAbvGr, SaleCondition, KitchenQual, </span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>         MSSubClassClean, HalfBath, LotArea)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="mvp-phase-1-get-scores-for-training-and-test-data" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> MVP Phase 1: Get scores for training and test data</h1>
<p>Let’s consider a CART model with the above variables and <code>cp</code> = <span class="math inline">\(\alpha\)</span> = 0. Let’s compute both the real Kaggle score on the test data and our first estimate of this score: the score on the training data.</p>
<section id="fit-and-visualize" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="fit-and-visualize"><span class="header-section-number">4.1</span> Fit and visualize</h2>
<p>First, fit this model and visualize it using <code>rpart.plot::rpart.plot()</code>, which IMO is an improvement over the base R generic <code>plot()</code> function</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create CART model with cp of 0</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>model_CART <span class="ot">&lt;-</span> <span class="fu">rpart</span>(SalePrice <span class="sc">~</span> GrLivArea <span class="sc">+</span> YearBuilt <span class="sc">+</span> BedroomAbvGr <span class="sc">+</span> SaleCondition <span class="sc">+</span> KitchenQual <span class="sc">+</span> MSSubClassClean <span class="sc">+</span> HalfBath <span class="sc">+</span> LotArea, <span class="at">data =</span> training, <span class="at">cp =</span> <span class="dv">0</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># plot CART model</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(model_CART)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="CART_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="768"></p>
</div>
</div>
</section>
<section id="compute-scores" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="compute-scores"><span class="header-section-number">4.2</span> Compute scores</h2>
<p>Compute and write your scores here:</p>
<ul>
<li>Training set score: 0.15220</li>
<li>Test set score from Kaggle: 0.20428</li>
</ul>
<p>Answer this question: Why do we observe the discrepancy between these two scores? The complex model caters too much to the training model (score is much lower than test), hindering its applicability to other data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add predicted values from CART model</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>training <span class="ot">&lt;-</span> <span class="fu">data_frame</span>(training, <span class="at">y_hat =</span> <span class="fu">predict</span>(model_CART)) </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># find rmsle for training data </span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>rmsle_training <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((<span class="fu">sum</span>((<span class="fu">log</span>(training<span class="sc">$</span>y_hat <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">log</span>(training<span class="sc">$</span>SalePrice <span class="sc">+</span> <span class="dv">1</span>))<span class="sc">^</span><span class="dv">2</span>))<span class="sc">/</span>(<span class="fu">nrow</span>(training)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># predict sales price on test using fitted/trained model</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>test<span class="sc">$</span>SalePrice <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_CART, <span class="at">newdata =</span> test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add sales price values to submission file</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>submission <span class="ot">&lt;-</span> sample_submission <span class="sc">%&gt;%</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SalePrice =</span> test<span class="sc">$</span>SalePrice)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># convert into file </span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(submission, <span class="at">path =</span> <span class="st">"data/submission.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="due-diligence-phase-2-get-a-better-estimate-of-the-kaggle-score" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Due Diligence Phase 2: Get a better estimate of the Kaggle score</h1>
<p>Using the same model with cp = 0 from above, obtain an <em>estimate</em> of the test set score Kaggle returns using the method from the <code>overfitting.R</code> lecture. Do not change the random number seed nor the training set split method from <code>overfitting.R</code>, so that all submissions will have the same split. Write your scores here:</p>
<ul>
<li>train_validation score: 0.16586</li>
<li>test_validation score: 0.20169</li>
</ul>
<p>Answer these questions:</p>
<ol type="1">
<li>Which of the above two scores is the estimate of the Kaggle score? test_validation score</li>
<li>Is this estimate of the Kaggle score better than the previous one? Why? This estimate of the Kaggle score is slightly better than the previous one because the train split is randomly generated. The randomly generated data mimics unseen data and allows it to build a better model for the test data. Using just the test data exposes the model to new characteristics that the model is not familiar with.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set seed</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">76</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># split training data into train_validation and test_validation</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>train_validation <span class="ot">&lt;-</span> training <span class="sc">%&gt;%</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_frac</span>(<span class="fl">0.5</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>test_validation <span class="ot">&lt;-</span> training <span class="sc">%&gt;%</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anti_join</span>(train_validation, <span class="at">by =</span> <span class="st">"Id"</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># check that the data has been split correctly </span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(training)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1460</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(train_validation) <span class="sc">+</span> <span class="fu">nrow</span>(test_validation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1460</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># CART model for train_validation</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>model_CART_split <span class="ot">&lt;-</span> <span class="fu">rpart</span>(SalePrice <span class="sc">~</span> GrLivArea <span class="sc">+</span> YearBuilt <span class="sc">+</span> BedroomAbvGr <span class="sc">+</span> SaleCondition <span class="sc">+</span> KitchenQual <span class="sc">+</span> MSSubClassClean <span class="sc">+</span> HalfBath <span class="sc">+</span> LotArea,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> train_validation,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">control =</span> <span class="fu">rpart.control</span>(<span class="at">cp =</span> <span class="dv">0</span>))</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># plot CART model</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(model_CART_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="CART_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="768"></p>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add predicted values from CART model fitted on train_validation</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>test_validation<span class="sc">$</span>SalePrice_hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_CART_split, <span class="at">newdata =</span> test_validation)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># add predicted values from CART model to train_validation</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>train_validation <span class="ot">&lt;-</span> <span class="fu">data_frame</span>(train_validation, <span class="at">SalePrice_hat =</span> <span class="fu">predict</span>(model_CART_split)) </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># find rmsle of train and test split </span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>rmsle_train_validation <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((<span class="fu">sum</span>((<span class="fu">log</span>(train_validation<span class="sc">$</span>SalePrice_hat <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">log</span>(train_validation<span class="sc">$</span>SalePrice <span class="sc">+</span> <span class="dv">1</span>))<span class="sc">^</span><span class="dv">2</span>))<span class="sc">/</span>(<span class="fu">nrow</span>(train_validation)))</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>rmsle_test_validation <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((<span class="fu">sum</span>((<span class="fu">log</span>(test_validation<span class="sc">$</span>SalePrice_hat <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">log</span>(test_validation<span class="sc">$</span>SalePrice <span class="sc">+</span> <span class="dv">1</span>))<span class="sc">^</span><span class="dv">2</span>))<span class="sc">/</span>(<span class="fu">nrow</span>(test_validation)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="phase-3-using-a-different-cp-value" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Phase 3: Using a different cp value</h1>
<p>Choose any different value of cp and obtain a new estimate of the Kaggle score. Write your scores here:</p>
<p>After choosing cp = 0.05, I got the following scores: - train_validation score: 0.27760 - test_validation score: 0.25121</p>
<p>Answer these questions:</p>
<ol type="1">
<li><strong>Without</strong> making a submission to Kaggle to see your actual score, which cp value would you use for your Kaggle submission? cp = 0 or your new value? New value</li>
<li>Why? I would use the model of cp = 0.05 because too much complexity when cp = 0 has many drawbacks. The overly complex CART model does not predict well to unseen data due to overfitting and leads to expensive, increased computational costs when cp = 0.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set seed</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">76</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># split training data into train_validation and test_validation</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>train_validation_new_cp <span class="ot">&lt;-</span> training <span class="sc">%&gt;%</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_frac</span>(<span class="fl">0.5</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>test_validation_new_cp <span class="ot">&lt;-</span> training <span class="sc">%&gt;%</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anti_join</span>(train_validation_new_cp, <span class="at">by =</span> <span class="st">"Id"</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co"># check that the data has been split correctly </span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(training)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1460</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(train_validation_new_cp) <span class="sc">+</span> <span class="fu">nrow</span>(test_validation_new_cp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1460</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># CART model for train_validation</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>model_CART_split_new_cp <span class="ot">&lt;-</span> <span class="fu">rpart</span>(SalePrice <span class="sc">~</span> GrLivArea <span class="sc">+</span> YearBuilt <span class="sc">+</span> BedroomAbvGr <span class="sc">+</span> SaleCondition <span class="sc">+</span> KitchenQual <span class="sc">+</span> MSSubClassClean <span class="sc">+</span> HalfBath <span class="sc">+</span> LotArea,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> train_validation_new_cp,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">control =</span> <span class="fu">rpart.control</span>(<span class="at">cp =</span> <span class="fl">0.05</span>))</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># plot CART model</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(model_CART_split_new_cp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="CART_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="768"></p>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add predicted values from CART model fitted on train_validation</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>test_validation_new_cp<span class="sc">$</span>SalePrice_hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_CART_split_new_cp, <span class="at">newdata =</span> test_validation_new_cp)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># add predicted values from CART model to train_validation</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>train_validation_new_cp <span class="ot">&lt;-</span> <span class="fu">data_frame</span>(train_validation_new_cp, <span class="at">SalePrice_hat =</span> <span class="fu">predict</span>(model_CART_split_new_cp)) </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># find rmsle of train and test split </span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>rmsle_train_validation_new_cp <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((<span class="fu">sum</span>((<span class="fu">log</span>(train_validation_new_cp<span class="sc">$</span>SalePrice_hat <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">log</span>(train_validation_new_cp<span class="sc">$</span>SalePrice <span class="sc">+</span> <span class="dv">1</span>))<span class="sc">^</span><span class="dv">2</span>))<span class="sc">/</span>(<span class="fu">nrow</span>(train_validation_new_cp)))</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>rmsle_test_validation_new_cp <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((<span class="fu">sum</span>((<span class="fu">log</span>(test_validation_new_cp<span class="sc">$</span>SalePrice_hat <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">log</span>(test_validation_new_cp<span class="sc">$</span>SalePrice <span class="sc">+</span> <span class="dv">1</span>))<span class="sc">^</span><span class="dv">2</span>))<span class="sc">/</span>(<span class="fu">nrow</span>(test_validation_new_cp)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="phase-4-using-several-different-cp-values" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Phase 4: Using several different cp values</h1>
<ol type="1">
<li>Repeat the above process for at least 100 different cp values</li>
<li>Plot all the scores in a ggplot with the following aesthetics:
<ol type="1">
<li>x-axis: cp complexity parameter</li>
<li>y-axis: RMSLE</li>
<li>color: training vs test set (i.e.&nbsp;your visualization should have two curves of different colors)</li>
</ol></li>
</ol>
<p>Qualitatively describe what you think are the two or three of the most salient patterns in this graph when it comes to understanding model complexity:</p>
<ol type="1">
<li><p>The rmsle remains constant (test = 0.38, train = 0.44) when cp &gt; 0.35 for the training and test set.</p></li>
<li><p>The rmsle is more sensitive when cps are small for both training and test sets.</p></li>
<li><p>When 0 &lt; cp &lt; 0.06, the rmsle increases at the fastest pace for both training and test sets.</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># number of values to generate for test and training </span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>n_values <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># generate 100 cp values from 0 to 1</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>cp_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1</span>, <span class="at">length=</span>n_values)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># generate 100 cp values to include cps from optimal range </span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>cp_grid1 <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="fl">0.1</span>, <span class="at">length=</span>n_values)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co"># set seed</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">76</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co"># split training data into train_validation and test_validation</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>train_validation_cp <span class="ot">&lt;-</span> training <span class="sc">%&gt;%</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_frac</span>(<span class="fl">0.5</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>test_validation_cp <span class="ot">&lt;-</span> training <span class="sc">%&gt;%</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anti_join</span>(train_validation_cp, <span class="at">by =</span> <span class="st">"Id"</span>)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co"># get rmsle for train validation </span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>get_rmsle_train <span class="ot">&lt;-</span> <span class="cf">function</span>(cp) {</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create model for chosen value for cp</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>  model_CART_split_cp <span class="ot">&lt;-</span> <span class="fu">rpart</span>(SalePrice <span class="sc">~</span> GrLivArea <span class="sc">+</span> YearBuilt <span class="sc">+</span> BedroomAbvGr <span class="sc">+</span> SaleCondition <span class="sc">+</span> KitchenQual <span class="sc">+</span> MSSubClassClean <span class="sc">+</span> HalfBath <span class="sc">+</span> LotArea,</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> train_validation_cp,</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>                      <span class="at">control =</span> <span class="fu">rpart.control</span>(<span class="at">cp =</span> cp))</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># predict CART model on train validation</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>  train_validation_cp <span class="ot">&lt;-</span> <span class="fu">data_frame</span>(train_validation_cp, <span class="at">SalePrice_hat =</span> <span class="fu">predict</span>(model_CART_split_cp)) </span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate rmsle for train validation</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>  rmsle_train_cp <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((<span class="fu">sum</span>((<span class="fu">log</span>(train_validation_cp<span class="sc">$</span>SalePrice_hat <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">log</span>(train_validation_cp<span class="sc">$</span>SalePrice <span class="sc">+</span> <span class="dv">1</span>))<span class="sc">^</span><span class="dv">2</span>))<span class="sc">/</span>(<span class="fu">nrow</span>(train_validation_cp)))</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove sale price hat or creates error </span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>  train_validation_cp <span class="ot">&lt;-</span> <span class="fu">subset</span>(train_validation_cp, <span class="at">select =</span> <span class="sc">-</span><span class="fu">c</span>(SalePrice_hat))</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return rmsle train validation score </span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(rmsle_train_cp)</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a><span class="co"># get rmsle for test validation </span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>get_rmsle_test <span class="ot">&lt;-</span> <span class="cf">function</span>(cp) {</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create model for chosen value for cp</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>  model_CART_split_cp <span class="ot">&lt;-</span> <span class="fu">rpart</span>(SalePrice <span class="sc">~</span> GrLivArea <span class="sc">+</span> YearBuilt <span class="sc">+</span> BedroomAbvGr <span class="sc">+</span> SaleCondition <span class="sc">+</span> KitchenQual <span class="sc">+</span> MSSubClassClean <span class="sc">+</span> HalfBath <span class="sc">+</span> LotArea,</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> train_validation_cp,</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>                      <span class="at">control =</span> <span class="fu">rpart.control</span>(<span class="at">cp =</span> cp))</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># predict CART model on test validation</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>  test_validation_cp<span class="sc">$</span>SalePrice_hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_CART_split_cp, <span class="at">newdata =</span> test_validation_cp)</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate rmsle for test validation</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>  rmsle_test_cp <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((<span class="fu">sum</span>((<span class="fu">log</span>(test_validation_cp<span class="sc">$</span>SalePrice_hat <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">log</span>(test_validation_cp<span class="sc">$</span>SalePrice <span class="sc">+</span> <span class="dv">1</span>))<span class="sc">^</span><span class="dv">2</span>))<span class="sc">/</span>(<span class="fu">nrow</span>(test_validation_cp)))</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove sale price hat or creates error </span></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>  test_validation_cp <span class="ot">&lt;-</span> <span class="fu">subset</span>(test_validation_cp, <span class="at">select =</span> <span class="sc">-</span><span class="fu">c</span>(SalePrice_hat))</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return rmsle test validation score </span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(rmsle_test_cp)</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize train and test rmsle vectors </span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>train_rmsle_vec <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(cp_grid))</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>test_rmsle_vec <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(cp_grid))</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate over each cp value</span></span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(cp_grid)) {</span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute RMSLE for the current cp value</span></span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>  rmsle_train <span class="ot">&lt;-</span> <span class="fu">get_rmsle_train</span>(cp_grid[i])</span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>  rmsle_test <span class="ot">&lt;-</span> <span class="fu">get_rmsle_test</span>(cp_grid[i])</span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Insert the computed RMSLE into train_rmsle_vec and test_rmsle_vec</span></span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>  train_rmsle_vec[i] <span class="ot">&lt;-</span> rmsle_train</span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>  test_rmsle_vec[i] <span class="ot">&lt;-</span> rmsle_test</span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a><span class="co"># focus on a lower cp range for more detailed analysis  </span></span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize train and test rmsle vectors for lower cp range </span></span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>train_rmsle_vec_low_cp <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(cp_grid1))</span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a>test_rmsle_vec_low_cp <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(cp_grid1))</span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate over each cp value</span></span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(cp_grid1)) {</span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute RMSLE for the current cp value</span></span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a>  rmsle_train1 <span class="ot">&lt;-</span> <span class="fu">get_rmsle_train</span>(cp_grid1[i])</span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a>  rmsle_test1 <span class="ot">&lt;-</span> <span class="fu">get_rmsle_test</span>(cp_grid1[i])</span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Insert the computed RMSLE into train_rmsle_vec and test_rmsle_vec</span></span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a>  train_rmsle_vec_low_cp[i] <span class="ot">&lt;-</span> rmsle_train1</span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a>  test_rmsle_vec_low_cp[i] <span class="ot">&lt;-</span> rmsle_test1</span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a><span class="co"># create table for rmsle values of train and test validation for cp values from 0 to 1</span></span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a>rmsle <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">cp =</span> cp_grid,</span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">training =</span> <span class="fu">unlist</span>(train_rmsle_vec),</span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">test =</span> <span class="fu">unlist</span>(test_rmsle_vec)</span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>cp, <span class="at">names_to =</span> <span class="st">"set"</span>, <span class="at">values_to =</span> <span class="st">"rmsle"</span>)</span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a><span class="co"># plot rmsle values for train and test on cps from 0 to 1</span></span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rmsle, <span class="fu">aes</span>(<span class="at">x=</span>cp, <span class="at">y=</span>rmsle, <span class="at">col =</span> set)) <span class="sc">+</span></span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="CART_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="768"></p>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create table for rmsle values of train and test validation for cp values from 0 to 0.1</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>rmsle1 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">cp =</span> cp_grid1,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">training =</span> <span class="fu">unlist</span>(train_rmsle_vec_low_cp),</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">test =</span> <span class="fu">unlist</span>(test_rmsle_vec_low_cp)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>cp, <span class="at">names_to =</span> <span class="st">"set"</span>, <span class="at">values_to =</span> <span class="st">"rmsle"</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co"># plot rmsle values for train and test on cps from 0 to 0.1</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rmsle1, <span class="fu">aes</span>(<span class="at">x=</span>cp, <span class="at">y=</span>rmsle, <span class="at">col =</span> set)) <span class="sc">+</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="CART_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid" width="768"></p>
</div>
</div>
</section>
<section id="phase-5-choosing-an-optimal-cp" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Phase 5: Choosing an optimal cp</h1>
<p>Based on your results in the previous section, identify the “optimal” cp to use and make a submission to kaggle using this value of cp and obtain your score. Write the following values:</p>
<ol type="1">
<li>What is your optimal cp value? 0.058586</li>
<li>What is your estimate of the RMSLE score returned by Kaggle associated with this optimal cp value? 0.27760</li>
<li>What is the actual Kaggle score associated with this optimal cp value? 0.29392</li>
<li>Which Kaggle score is better? The one for cp = 0 or for your optimal cp value? ( No need to answer why.) The Kaggle score for cp = 0 is better.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create CART model with optimal cp chosen to balance complexity and fit </span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>model_CART_optimal_cp <span class="ot">&lt;-</span> <span class="fu">rpart</span>(SalePrice <span class="sc">~</span> GrLivArea <span class="sc">+</span> YearBuilt <span class="sc">+</span> BedroomAbvGr <span class="sc">+</span> SaleCondition <span class="sc">+</span> KitchenQual <span class="sc">+</span> MSSubClassClean <span class="sc">+</span> HalfBath <span class="sc">+</span> LotArea, <span class="at">data =</span> training, <span class="at">cp =</span> <span class="fl">0.05858</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># plot CART model of optimal cp</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(model_CART_optimal_cp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="CART_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="768"></p>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># predict sales price on test using fitted/trained model</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>test<span class="sc">$</span>SalePrice <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_CART_optimal_cp, <span class="at">newdata =</span> test)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># add sales price values to submission file</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>submission_optimal_cp <span class="ot">&lt;-</span> sample_submission <span class="sc">%&gt;%</span> </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SalePrice =</span> test<span class="sc">$</span>SalePrice)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># convert into file </span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(submission, <span class="at">path =</span> <span class="st">"data/submission_optimal_cp.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="make-kaggle-submission-and-post-screenshot" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="make-kaggle-submission-and-post-screenshot"><span class="header-section-number">8.1</span> Make Kaggle submission and post screenshot</h2>
<p>After making your submission on Kaggle, take a screenshot, and replace the image of my score with the image of yours below.</p>
<p><img src="images/score_screenshot.png" class="img-fluid" style="width:100.0%"></p>
</section>
</section>
<section id="point-of-diminished-returns-phase-6-improving-kaggle-test-set-score-estimates" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Point of Diminished Returns Phase 6: Improving Kaggle test set score estimates</h1>
<p>Implement a mechanism for further improving the estimate for the Kaggle score yielded by the train_validation and test_validation split.</p>
<p>I implemented 10-fold cross validation as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set seed</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">76</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># define 10 folds for 10-fold cross validation</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>num_folds <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># randomly split the data into 10 folds</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(training<span class="sc">$</span>SalePrice, <span class="at">k =</span> num_folds, <span class="at">list =</span> <span class="cn">TRUE</span>, <span class="at">returnTrain =</span> <span class="cn">FALSE</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize a vector to hold k-fold numbers </span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>index <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(training))</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co"># iterate along folds </span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(folds)) {</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add fold numbers to index vector </span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  index[folds[[i]]] <span class="ot">&lt;-</span> i</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="co"># add the index column to your dataset</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>training <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">index =</span> index, training)</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize vector to hold 10 rmsle scores of test_validation</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>rmsle_score <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, num_folds)</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="co"># iterate along k folds </span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_folds) {</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># initialize test and train validation </span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>  test_validation_k_fold <span class="ot">&lt;-</span> training <span class="sc">|&gt;</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(index <span class="sc">==</span> i)</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>  train_validation_k_fold <span class="ot">&lt;-</span> training <span class="sc">|&gt;</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(index <span class="sc">!=</span> i)</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fit a CART model of cp 0 </span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>  model_CART_k_fold <span class="ot">&lt;-</span> <span class="fu">rpart</span>(SalePrice <span class="sc">~</span> GrLivArea <span class="sc">+</span> YearBuilt <span class="sc">+</span> BedroomAbvGr <span class="sc">+</span> SaleCondition <span class="sc">+</span> KitchenQual <span class="sc">+</span> MSSubClassClean <span class="sc">+</span> HalfBath <span class="sc">+</span> LotArea, <span class="at">data =</span> train_validation_k_fold, <span class="at">cp =</span> <span class="dv">0</span>)</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># predict sales price on test validation using fitted/trained model on train validation </span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>  test_validation_k_fold<span class="sc">$</span>SalePrice_hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_CART_k_fold, <span class="at">newdata =</span> test_validation_k_fold)</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate rmsle score for the ith fold and add it to the rmsle_score vector </span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>  rmsle_score[i] <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((<span class="fu">sum</span>((<span class="fu">log</span>(test_validation_k_fold<span class="sc">$</span>SalePrice_hat <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">log</span>(test_validation_k_fold<span class="sc">$</span>SalePrice <span class="sc">+</span> <span class="dv">1</span>))<span class="sc">^</span><span class="dv">2</span>))<span class="sc">/</span>(<span class="fu">nrow</span>(test_validation_k_fold)))</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a><span class="co"># find average among k rmsle scores </span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>avg_rmsle <span class="ot">&lt;-</span> <span class="fu">mean</span>(rmsle_score)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The estimated rmsle score of 0.198 is better than the test_validation score of 0.202 when cp = 0.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>